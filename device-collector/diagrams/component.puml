@startuml C4_Elements
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
!$ICONURL = "https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v3.0.0/icons"
!include $ICONURL/devicons2/spring_original.puml
!include $ICONURL/font-awesome-6/golang.puml
!include $ICONURL/devicons2/redis.puml
!include $ICONURL/font-awesome-6/key.puml
!include $ICONURL/devicons2/apachekafka_original.puml
!include $ICONURL/font-awesome-6/robot.puml
!include $ICONURL/devicons/postgresql.puml
!include $ICONURL/devicons2/cassandra.puml
!include $ICONURL/font-awesome-6/server.puml
!include $ICONURL/devicons2/prometheus_original.puml
!include $ICONURL/font-awesome-6/computer.puml
!include $ICONURL/devicons2/grafana.puml

Container_Boundary(iot-devices, IoT) {
    Boundary(microservices, "Events Collector") {
        Container(kafka_service, "KafkaService", "Spring Boot", "Чтение событий из\nтопика device-id-topic", $sprite=spring_original)
        Container(springs_actuator, "Spring Actuator", "Spring Boot", "Логи, метрики, трейсы", $sprite=spring_original)
        Container(device_collector_service, "Device Collector Service", "Spring Boot", "Отправка уникальных device\nв apache sharding sphere", $sprite=spring_original)
    }

    Boundary(sharding_sphere, "Sharding with replication") {
        Container_Ext(postgre_shard0, "PostgreSQL", "master shard0", "Мастер шард", $sprite=postgresql)
        Container_Ext(postgre_replica0, "PostgreSQL", "slave shard0", "Реплика", $sprite=postgresql)
        Container_Ext(postgre_shard1, "PostgreSQL", "master shard1", "Мастер шард", $sprite=postgresql)
        Container_Ext(postgre_replica1, "PostgreSQL", "slave shard1", "Реплика", $sprite=postgresql)

    }

    Boundary(observability, "Observability") {
        Container_Ext(node_exporter, "Node exporter", "Агент сбора метрик ОС", "CPU / RAM / SWAP / etc", $sprite=computer)
        Container_Ext(postgresql_exporter, "PostgreSQL exporter", "Агент сбора метрик PostgreSQL", "Количество активных соединений / использование памяти / время выполнения запросов / etc", $sprite=computer)
        Container_Ext(kafka_exporter, "Kafka exporter", "Агент сбора метрик Kafka", "Загрузку брокеров / Производительность / Состояние потребителей / Состояние топиков / etc", $sprite=computer)

        Container_Ext(prometheus, "Prometheus", "Система мониторинга", "Сбор метрик", $sprite = prometheus_original)
        Container_Ext(loki, "Loki", "Система сбора логов", "Сбор, индексация, хранение логов", $sprite = computer)
        Container_Ext(tempo, "Tempo", "Система мониторинга", "Хранение и анализ трейсов", $sprite = computer)
        Container_Ext(alloy, "Alloy", "Универсальный агент", "Обработка и передача трейсов", $sprite = computer)
        Container_Ext(grafana, "Grafana", "Визуализация мониторинга", "Анализ и визуализация мониторинга", $sprite = grafana)
    }

    Boundary(ext_containers, "System Ext") {
        Container_Ext(kafka, "Kafka", "Kafka", "events / dlt / device-id / топики", $sprite=apachekafka_original)
    }
}

Container_Ext(iot, "IoT Devices", "Встраиваемые устройства", "Отправляют телеметрию и получаются комангды", $sprite=robot)

Rel(iot, kafka, "Отправка events в топик events.in")

Rel(kafka_service, kafka, "Батчевое получение телеметрии")
Rel(kafka_service, device_collector_service, "Отправка сообщений\nв сервис по отправке\nв Sharding Sphere")
Rel(device_collector_service, sharding_sphere, "Сохранение уникальных девайсов", "HTTP")


Rel(prometheus, node_exporter, "")
Rel(prometheus, postgresql_exporter, "")
Rel(prometheus, kafka_exporter, "")
Rel(grafana, prometheus, "")
Rel(alloy, tempo, "")
Rel(grafana, tempo, "")
Rel(grafana, loki, "")

Rel(postgre_replica0, postgre_shard0, "копирование данных с master (shard0) на slave (replica0)")
Rel(postgre_replica1, postgre_shard1, "копирование данных с master (shard1) на slave (replica1)")

Rel(observability, springs_actuator, "Получение метрик, логов, трейсов")
Rel(observability, ext_containers, "Получение метрик, логов, трейсов")
@enduml